# Deployment

## Introduction

This lab takes you through deploying the Micronaut application to an OCI VM.

Estimated Lab Time: 10 minutes

### Objectives

In this lab you will:

* Build your application distribution
* Upload the application distribution and wallet to an OCI VM
* Run your application on the OCI VM

## **STEP 1**:  Deploy Micronaut Application to OCI

### Deploy (From Local To VM)

Note that steps 4 and 5 are not necessary if you deployed the Helidon native image in the previous Lab to the VM.

1. Before deploying, ensure the wallet exists on the VM by running the snippet produced by `setup.sh` that looks similar to:

    ```
    # run on local machine to push to VM
    <copy>
    scp -i ~/.ssh/id_rsa -r /tmp/wallet opc@[VM IP Address]:/tmp/wallet
    </copy>
    ```

  Note that the command above refers to the directory where you extracted the wallet to (in this case `/tmp/wallet`). If you extracted to a different location you will need to alter the command appropriately.  

2. Build a runnable JAR file with:

    ```
    # run on local machine
    <copy>
    ./gradlew assemble
    </copy>
    ```

3. Push the runnable JAR file to VM with the snippet produced by *setup.sh* that looks similar to this:

    ```
    # run on local machine to push to VM
    <copy>
    ssh -i ~/.ssh/id_rsa opc@$[VM IP Address] sudo mkdir /app
    ssh -i ~/.ssh/id_rsa opc@$[VM IP Address] sudo chown opc /app
    scp -i ~/.ssh/id_rsa -r build/libs/example-atp-0.1-all.jar opc@[VM IP Address]:/app/application.jar
    </copy>
    ```

  Note that it is important that you copy the JAR file that ends with `-all.jar` which represents the runnable JAR file.  

4. Push the Helidon native image to the VM:

    ```
    # run on local machine to push to VM, from the directory that contains downloaded native image
    <copy>
    scp -i ~/.ssh/id_rsa ./helidon-mp-service opc@[VM IP Address]:/app/helidon-mp-service
    </copy>
    ```

5. Run the Helidon application on the VM:

    ```
    # run on VM to start Helidon application
    <copy>
    ./app/helidon-mp-service
    </copy>
    ```

4. To run on the VM, SSH in and run the snippet generated by `setup.sh` that looks similar to this:

    ```
    <copy>
    # run on VM to start Micronaut application
    export DATASOURCES_DEFAULT_PASSWORD=[Your atp_wallet_password]
    export TNS_ADMIN=/tmp/wallet
    java -jar /app/application.jar
    </copy>
    ```

### _Alternative: Build and run on VM only_
If you ran into trouble building or deploying the Microservice applications presented in previous steps, you may use the following instructions to build and deploy them directly to the OCI VM:


1. Download and run Helidon MP native image on VM:

    ```
    <copy>
    # ssh to VM
    ssh -i ~/.ssh/id_rsa opc@[VM IP Address]
      
    # download and run Helidon native image app 
    curl https://objectstorage.us-phoenix-1.oraclecloud.com/n/toddrsharp/b/micronaut-lab-assets/o/helidon-mp-service -o /app/helidon-mp-service
    chmod +x /app/helidon-mp-service
    ./app/helidon-mp-service
    </copy>
    ```

2. Build and run Micronaut application:
    ```
    <copy>
    # ssh to VM
    ssh -i ~/.ssh/id_rsa opc@[VM IP Address]
   
    # export variables to connect to Oracle Autonomous Database
    export TNS_ADMIN=[Your absolute path to wallet]
    export DATASOURCES_DEFAULT_PASSWORD=[Your atp_schema_password]
   
    # checkout micronaut source code
    git clone -b lab6 https://github.com/graemerocher/micronaut-hol-example.git
   
    # run micronaut app
    cd micronaut-hol-example
    ./gradlew run -t
    </copy>
     ```

## **STEP 2**:  Verify Application

You can now access `http://[VM IP Address]:8080/pets` for the `/pet` endpoint and `http://[VM IP Address]:8080/owners` for the `/owners` endpoint in a browser or using `curl`:

    curl -i http://[VM IP Address]:8080/pets
    HTTP/1.1 200 OK
    Date: Thu, 20 Aug 2020 15:12:47 GMT
    Content-Type: application/json
    content-length: 55
    connection: keep-alive

    [{"name":"Dino"},{"name":"Baby Puss"},{"name":"Hoppy"}]

You may now *proceed to the next lab*.

## Acknowledgements
- **Owners** - Graeme Rocher, Architect, Oracle Labs - Databases and Optimization
- **Contributors** - Chris Bensen, Todd Sharp, Eric Sedlar
- **Last Updated By** - Kay Malcolm, DB Product Management, August 2020

## Need Help?
Please submit feedback or ask for help using our [LiveLabs Support Forum](https://community.oracle.com/tech/developers/categories/building-java-cloud-applications-with-micronaut-and-oci). Please click the **Log In** button and login using your Oracle Account. Click the **Ask A Question** button to the left to start a *New Discussion* or *Ask a Question*.  Please include your workshop name and lab name.  You can also include screenshots and attach files.  Engage directly with the author of the workshop.

If you do not have an Oracle Account, click [here](https://profile.oracle.com/myprofile/account/create-account.jspx) to create one.
